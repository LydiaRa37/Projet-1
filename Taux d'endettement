-- taux d'endettement 

 SELECT 
    c.customerNumber,
    c.customerName,
    c.city,
    c.country,
    c.creditLimit,
    SUM(od.quantityOrdered * od.priceEach) AS totalPurchases,
    COALESCE(SUM(p.amount), 0) AS totalPayments,
    COALESCE(SUM(p.amount), 0) - SUM(od.quantityOrdered * od.priceEach) AS montantImpayé,
    ROUND((COALESCE(SUM(p.amount), 0) - SUM(od.quantityOrdered * od.priceEach)) / c.creditLimit * 100, 0) AS pourcentageImpayé
FROM 
    customers c
JOIN 
    orders o ON c.customerNumber = o.customerNumber
JOIN 
    orderdetails od ON o.orderNumber = od.orderNumber
LEFT JOIN 
    payments p ON c.customerNumber = p.customerNumber 
              AND YEAR(o.orderDate) = YEAR(p.paymentDate)
WHERE 
    YEAR(o.orderDate) BETWEEN 2022 AND 2024
GROUP BY 
    c.customerNumber, c.customerName, c.city, c.country, c.creditLimit;
